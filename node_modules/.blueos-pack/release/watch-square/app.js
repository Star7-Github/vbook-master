let x={"@info":{styleObjectId:1411120752}};const _=x,$=$app_require$("@app-module/system.fetch"),T=$app_require$("@app-module/system.fetch"),m=$app_require$("@app-module/system.file"),i=$app_require$("@app-module/system.prompt"),a={};function C(){return T&&typeof T.fetch=="function"?e=>T.fetch(e):typeof $=="function"?$:$&&typeof $.fetch=="function"?e=>$.fetch(e):null}function F(e){return new Promise(s=>{m.mkdir({uri:e,recursive:!0,success:()=>s({success:!0}),fail:(n,r)=>{m.access({uri:e,success:()=>s({success:!0}),fail:(o,l)=>s({success:!1,msg:r})})}})})}function P(e){return new Promise(s=>{m.list({uri:e,success:n=>s(n.fileList||[]),fail:()=>s([])})})}function O(e,s,n){return new Promise(r=>m.writeText({uri:`${e}/${s}.txt`,text:n,success:()=>r(!0),fail:(o,l)=>{i.showToast({message:`保存失败: ${l}`}),r(!1)}}))}function q(e,s){return new Promise(n=>{const r=C();if(!r){i.showToast({message:"Fetch未初始化"}),n(null);return}r({url:`http://127.0.0.1:23101/api/novel/chapter?id=${e}&index=${s}`,method:"GET",responseType:"text",success:o=>{o.code===200||o.code===206?n(o.data):(i.showToast({message:`下载错${s}: ${o.code}`}),n(null))},fail:(o,l)=>{i.showToast({message:`网络连不上${s}: ${l}`}),n(null)}})})}async function A(e){const s=e.id,n=parseInt(e.chapterCount)||0,r={id:e.id,name:e.name,chapterCount:e.chapterCount,currentChapter:0,isOffline:!1},o=`book_${e.id}.json`;m.writeText({uri:`internal://files/${o}`,text:JSON.stringify(r)});const l=`internal://files/book_data_${e.id}`;if(!(await F(l)).success){i.showToast({message:`目录创建失败: ${e.name}`}),a[s].status="error";return}const u=await P(l);if(console.log(`[App] Book ${e.name} existing files: ${u.length}`),u.length>100&&i.showToast({message:"正在检查已下载章节..."}),u.length>0){const t=u[0],f=t.filename||(t.uri?t.uri.split("/").pop():"N/A");u.length<=100&&i.showToast({message:`首文件: ${f} (总${u.length})`})}else i.showToast({message:"无缓存文件 (总0)"});const g=new Set;for(let t=0;t<u.length;t++){const f=u[t];let c=f.filename;if(!c&&f.uri){const h=f.uri.split("/");c=h[h.length-1]}g.add(c),t%200===0&&t>0&&await new Promise(h=>setTimeout(h,1))}let w=a[s],p=0,d=0;for(let t=0;t<n&&a[s].status==="running";t++){if(p>50){i.showToast({message:`${e.name} 失败过多，请稍后重试以补全`}),w.status="error";break}const f=`${t}.txt`;if(g.has(f))p=0,t%50===0&&await new Promise(c=>setTimeout(c,1));else try{const c=await q(e.id,t);c?(await O(l,t,c),g.add(f),p=0):(p++,d++,console.log(`[App] Download fail ch ${t}, consecutive: ${p}`))}catch(c){p++,d++,console.log(`[App] Download error ch ${t}: ${c}`)}w.progress=Math.floor((t+1)/n*100)}w.status="done",d===0?(r.isOffline=!0,m.writeText({uri:`internal://files/${o}`,text:JSON.stringify(r)}),i.showToast({message:`${e.name} 下载完成`})):i.showToast({message:`${e.name} 缺${d}章，点下载可补全`})}const y={onCreate(){},start(e){if(a[e.id]&&a[e.id].status==="running"){i.showToast({message:"正在后台下载中..."});return}a[e.id]={id:e.id,progress:0,status:"running",name:e.name},i.showToast({message:`已加入后台下载: ${e.name}`}),A(e)},getTask(e){return a[e]},getRunningTask(){for(const e in a)if(a[e].status==="running")return a[e];return null},clearTask(e){a[e]&&(a[e].status="cancelled",delete a[e],console.log(`[App] Cleared task for book ${e}`))}};$app_define$("@app-component/app",[],function(e,s,n){n.exports=y.default||y,n.exports.style=_});$app_bootstrap$("@app-application/app");
