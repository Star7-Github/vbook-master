let p={"@info":{styleObjectId:1561212216}};const d=p,f=$app_require$("@app-module/system.router"),l=$app_require$("@app-module/system.fetch"),c=$app_require$("@app-module/system.fetch"),n=$app_require$("@app-module/system.file"),r=$app_require$("@app-module/system.prompt"),u={data:function(){return{bookList:[],isLoading:!0,isDownloading:!1,downloadProgress:0,curBookName:"",curBookAuthor:"",monitorId:"",phaseText:"下载列表"}},onDestroy(){this.timerId&&clearTimeout(this.timerId),this.intervalId&&clearInterval(this.intervalId),this.pollTimer&&clearInterval(this.pollTimer)},onInit(){this.timerId=null,this.intervalId=null,this.pollTimer=null,this.fakeProgress=0,this.fetchBookList()},onShow(){if(this.fetchBookList(),this.$app&&this.$app.$def&&this.$app.$def.getRunningTask){const t=this.$app.$def.getRunningTask();t&&(this.isDownloading=!0,this.curBookName=t.name||"",this.curBookAuthor="本地导入",this.monitorId=t.id,this.downloadProgress=t.progress||0,this.startPolling())}},startDownload(t){if(this.isDownloading){r.showToast({message:"请等待当前下载完成"});return}if((parseInt(t.chapterCount)||0)===0){r.showToast({message:"章节数为0"});return}this.isDownloading=!0,this.curBookName=t.name,this.curBookAuthor=t.author,this.downloadProgress=0,this.monitorId=t.id,this.$app&&this.$app.$def&&this.$app.$def.start?(this.$app.$def.start(t),this.startPolling()):(r.showToast({message:"应用异常"}),this.isDownloading=!1)},startPolling(){this.pollTimer&&clearInterval(this.pollTimer),this.fakeProgress=0,this.lastPhase="",this.pollTimer=setInterval(()=>{if(!this.monitorId)return;const t=this.$app.$def.getTask(this.monitorId);t&&(this.downloadProgress=t.progress||0,t.phase==="download"?this.phaseText=`下载中 ${this.downloadProgress}%`:t.phase==="batch"?this.phaseText=`备用下载 ${this.downloadProgress}%`:this.phaseText="下载中...",t.status!=="running"&&(t.status==="done"?(this.downloadProgress=100,this.phaseText="下载完成",r.showToast({message:"下载完成"})):r.showToast({message:"下载出错"}),setTimeout(()=>{this.isDownloading=!1,this.monitorId="",this.phaseText="下载列表",this.fakeProgress=0,clearInterval(this.pollTimer),this.fetchBookList()},1500)))},500)},goBack(){f.back()},getFetch(){return c&&typeof c.fetch=="function"?t=>c.fetch(t):typeof l=="function"?l:l&&typeof l.fetch=="function"?t=>l.fetch(t):null},async fetchBookList(){this.isLoading=!0,console.log("正在请求书单");const t=await this.getLocalBooks(),s={};t.forEach(e=>s[e.id]=e);const o=this.getFetch();if(!o){r.showToast({message:"API不支持"}),this.isLoading=!1;return}o({url:"http://127.0.0.1:23101/api/novel/list",method:"GET",responseType:"json",success:e=>{let i=[];Array.isArray(e.data)?i=e.data:e.data&&Array.isArray(e.data.data)&&(i=e.data.data),this.bookList=i.map(a=>{const h=s[a.id];return{id:a.id,name:a.name,author:"本地导入",size:a.size,chapterCount:a.chapterCount,isDownloaded:!!h&&h.isOffline,localExists:!!h}}),this.isLoading=!1},fail:(e,i)=>{console.log(`书单请求失败: ${i}, ${e}`),r.showToast({message:"网络请求失败"}),this.isLoading=!1,this.bookList=[]}})},getLocalBooks(){return new Promise(t=>{n.list({uri:"internal://files/",success:s=>{const e=(s.fileList||[]).filter(i=>i.uri.indexOf("book_")>=0&&i.uri.endsWith(".json"));Promise.all(e.map(i=>this.readText(i.uri))).then(i=>{t(i.map(a=>{try{return JSON.parse(a)}catch{return null}}).filter(a=>a))})},fail:()=>t([])})})},readText(t){return new Promise(s=>n.readText({uri:t,success:o=>s(o.text),fail:()=>s(null)}))},ensureDir(t){return new Promise(s=>{n.mkdir({uri:t,recursive:!0,success:()=>s({success:!0}),fail:(o,e)=>{console.log(`mkdir ${t} failed: ${e} ${o}`),n.access({uri:t,success:()=>s({success:!0}),fail:(i,a)=>{s({success:!1,msg:`MKDIR:${e},ACCESS:${a}`})}})}})})},checkFileExists(t){return new Promise(s=>{n.access({uri:t,success:()=>s(!0),fail:()=>s(!1)})})},downloadChapterOne(t,s){return new Promise(o=>{const e=this.getFetch();if(!e){o(null);return}e({url:`http://127.0.0.1:23101/api/novel/chapter?id=${t}&index=${s}`,method:"GET",responseType:"text",success:i=>{i.code===200||i.code===206?o(i.data):o(null)},fail:()=>o(null)})})},saveChapterFile(t,s,o){return new Promise(e=>{n.writeText({uri:`${t}/${s}.txt`,text:o,success:()=>e(!0),fail:(i,a)=>{console.log(`Save ch ${s} fail: ${a}`),e(!1)}})})}};$app_define$("@app-component/index",[],function(t,s,o){o.exports=u.default||u,o.exports.style=d});$app_bootstrap$("@app-component/index");
