let p={"@info":{styleObjectId:1561212216}};const d=p,f=$app_require$("@app-module/system.router"),l=$app_require$("@app-module/system.fetch"),u=$app_require$("@app-module/system.fetch"),n=$app_require$("@app-module/system.file"),r=$app_require$("@app-module/system.prompt"),h={data:function(){return{bookList:[],isLoading:!0,isDownloading:!1,downloadProgress:0,curBookName:"",curBookAuthor:"",monitorId:""}},onDestroy(){this.timerId&&clearTimeout(this.timerId),this.intervalId&&clearInterval(this.intervalId),this.pollTimer&&clearInterval(this.pollTimer)},onInit(){this.timerId=null,this.intervalId=null,this.pollTimer=null,this.fetchBookList()},startDownload(t){if(this.isDownloading){r.showToast({message:"请等待当前下载完成"});return}if((parseInt(t.chapterCount)||0)===0){r.showToast({message:"章节数为0"});return}this.isDownloading=!0,this.curBookName=t.name,this.curBookAuthor=t.author,this.downloadProgress=0,this.monitorId=t.id,this.$app&&this.$app.$def&&this.$app.$def.start?(this.$app.$def.start(t),this.startPolling()):(r.showToast({message:"应用异常"}),this.isDownloading=!1)},startPolling(){this.pollTimer&&clearInterval(this.pollTimer),this.pollTimer=setInterval(()=>{if(!this.monitorId)return;const t=this.$app.$def.getTask(this.monitorId);t&&(this.downloadProgress=t.progress||0,t.status!=="running"&&(t.status==="done"?(this.downloadProgress=100,r.showToast({message:"下载完成"})):r.showToast({message:"下载出错"}),setTimeout(()=>{this.isDownloading=!1,this.monitorId="",clearInterval(this.pollTimer)},1500)))},500)},goBack(){f.back()},getFetch(){return u&&typeof u.fetch=="function"?t=>u.fetch(t):typeof l=="function"?l:l&&typeof l.fetch=="function"?t=>l.fetch(t):null},async fetchBookList(){this.isLoading=!0,console.log("正在请求书单");const t=await this.getLocalBooks(),s={};t.forEach(e=>s[e.id]=e);const i=this.getFetch();if(!i){r.showToast({message:"API不支持"}),this.isLoading=!1;return}i({url:"http://127.0.0.1:23101/api/novel/list",method:"GET",responseType:"json",success:e=>{let o=[];Array.isArray(e.data)?o=e.data:e.data&&Array.isArray(e.data.data)&&(o=e.data.data),this.bookList=o.map(a=>{const c=s[a.id];return{id:a.id,name:a.name,author:"本地导入",size:a.size,chapterCount:a.chapterCount,isDownloaded:!!c&&c.isOffline,localExists:!!c}}),this.isLoading=!1},fail:(e,o)=>{console.log(`书单请求失败: ${o}, ${e}`),r.showToast({message:"网络请求失败"}),this.isLoading=!1,this.bookList=[]}})},getLocalBooks(){return new Promise(t=>{n.list({uri:"internal://files/",success:s=>{const e=(s.fileList||[]).filter(o=>o.uri.indexOf("book_")>=0&&o.uri.endsWith(".json"));Promise.all(e.map(o=>this.readText(o.uri))).then(o=>{t(o.map(a=>{try{return JSON.parse(a)}catch{return null}}).filter(a=>a))})},fail:()=>t([])})})},readText(t){return new Promise(s=>n.readText({uri:t,success:i=>s(i.text),fail:()=>s(null)}))},ensureDir(t){return new Promise(s=>{n.mkdir({uri:t,recursive:!0,success:()=>s({success:!0}),fail:(i,e)=>{console.log(`mkdir ${t} failed: ${e} ${i}`),n.access({uri:t,success:()=>s({success:!0}),fail:(o,a)=>{s({success:!1,msg:`MKDIR:${e},ACCESS:${a}`})}})}})})},checkFileExists(t){return new Promise(s=>{n.access({uri:t,success:()=>s(!0),fail:()=>s(!1)})})},downloadChapterOne(t,s){return new Promise(i=>{const e=this.getFetch();if(!e){i(null);return}e({url:`http://127.0.0.1:23101/api/novel/chapter?id=${t}&index=${s}`,method:"GET",responseType:"text",success:o=>{o.code===200?i(o.data):i(null)},fail:()=>i(null)})})},saveChapterFile(t,s,i){return new Promise(e=>{n.writeText({uri:`${t}/${s}.txt`,text:i,success:()=>e(!0),fail:(o,a)=>{console.log(`Save ch ${s} fail: ${a}`),e(!1)}})})}};$app_define$("@app-component/index",[],function(t,s,i){i.exports=h.default||h,i.exports.style=d});$app_bootstrap$("@app-component/index");
