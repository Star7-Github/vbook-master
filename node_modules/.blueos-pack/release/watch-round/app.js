let G={"@info":{styleObjectId:1411120752}};const K=G,_=$app_require$("@app-module/system.fetch"),j=$app_require$("@app-module/system.fetch"),A=$app_require$("@app-module/system.request"),m=$app_require$("@app-module/system.file"),g=$app_require$("@app-module/system.prompt"),L=$app_require$("@app-module/system.brightness"),h={},P="http://192.168.0.105:23101",D=5;function E(){return j&&typeof j.fetch=="function"?e=>j.fetch(e):typeof _=="function"?_:_&&typeof _.fetch=="function"?e=>_.fetch(e):null}function I(e){return new Promise(s=>{m.mkdir({uri:e,recursive:!0,success:()=>s({success:!0}),fail:(n,t)=>{m.access({uri:e,success:()=>s({success:!0}),fail:(i,l)=>s({success:!1,msg:t})})}})})}function H(e){return new Promise(s=>{m.list({uri:e,success:n=>s(n.fileList||[]),fail:()=>s([])})})}function V(e){return new Promise(s=>m.readText({uri:e,success:n=>s(n.text),fail:()=>s(null)}))}function Z(e){return new Promise(s=>m.delete({uri:e,success:()=>s(!0),fail:()=>s(!1)}))}function B(e,s,n){return new Promise(t=>m.writeText({uri:`${e}/${s}.txt`,text:n,success:()=>t(!0),fail:(i,l)=>{console.log(`[App] saveChapter fail ${s}: ${l}`),t(!1)}}))}function x(e){try{L.setKeepScreenOn({keepScreenOn:e,success:()=>console.log(`[App] KeepScreenOn: ${e}`),fail:(s,n)=>console.log(`[App] KeepScreenOn fail: ${n}`)})}catch(s){console.log(`[App] brightness error: ${s}`)}}function z(e){return new Promise(s=>{const n=E();if(!n){s(null);return}n({url:`${P}/api/novel/catalog?id=${e}`,method:"GET",responseType:"json",success:t=>{if(t.code===200||t.code===206){let i=t.data;if(typeof i=="string")try{i=JSON.parse(i)}catch{s(null);return}s(i&&i.chapters?i.chapters:null)}else s(null)},fail:()=>s(null)})})}function Q(e,s,n){return new Promise(t=>{if(!A||typeof A.download!="function"){t(null);return}const i=`internal://files/_temp_batch_${e}.json`,l=`${P}/api/novel/chapters?id=${e}&from=${s}&to=${n}&dl=1`;A.download({url:l,filename:i,success:r=>{const f=r.token;A.onDownloadComplete({token:f,success:()=>{m.access({uri:i,success:()=>t(i),fail:()=>{console.log("[App] Batch temp file not found"),t(null)}})},fail:(d,w)=>{console.log(`[App] Batch download complete fail: ${w}`),t(null)}})},fail:(r,f)=>{console.log(`[App] Batch download fail: ${f}`),t(null)}})})}async function W(e,s,n,t){let i=await V(e);if(!i)return console.log("[App] Failed to read batch temp file"),{saved:0,failed:n.length};let l=null;try{l=JSON.parse(i)}catch(d){return console.log(`[App] Failed to parse batch JSON: ${d}`),{saved:0,failed:n.length}}i=null;let r=0,f=0;for(const d of n){const w=String(d);if(l[w]){const b=await B(s,d,l[w]);l[w]=null,b?(t.add(`${d}.txt`),r++):f++,await new Promise($=>setTimeout($,50))}else f++}return l=null,{saved:r,failed:f}}function X(e,s,n){return new Promise(t=>{const i=E();if(!i){t(null);return}i({url:`${P}/api/novel/chapters?id=${e}&from=${s}&to=${n}`,method:"GET",responseType:"json",success:l=>{if(l.code===200||l.code===206){let r=l.data;if(typeof r=="string")try{r=JSON.parse(r)}catch{t(null);return}t(r)}else t(null)},fail:()=>t(null)})})}function Y(e,s){return new Promise(n=>{const t=E();if(!t){n(null);return}t({url:`${P}/api/novel/chapter?id=${e}&index=${s}`,method:"GET",responseType:"text",success:i=>{i.code===200||i.code===206?n(i.data):n(null)},fail:()=>n(null)})})}async function v(e){const s=e.id,n=parseInt(e.chapterCount)||0,t=h[s],i=await z(s),l=Array.isArray(i)?i.map(a=>({title:a.title||""})):[],r={id:e.id,name:e.name,chapterCount:e.chapterCount,currentChapter:0,isOffline:!1,chapters:l},f=`book_${e.id}.json`;await new Promise(a=>{m.writeText({uri:`internal://files/${f}`,text:JSON.stringify(r),success:()=>{console.log(`[App] Meta saved with ${l.length} chapter titles`),a(!0)},fail:(o,u)=>{console.log(`[App] Meta save fail: ${u}`),a(!1)}})});const d=`internal://files/book_data_${e.id}`;if(!(await I(d)).success){g.showToast({message:"目录创建失败"}),t.status="error",x(!1);return}const b=await H(d),$=new Set;for(const a of b){let o=a.filename;if(!o&&a.uri){const u=a.uri.split("/");o=u[u.length-1]}$.add(o)}let M=0;for(let a=0;a<n;a++)$.has(`${a}.txt`)||M++;if(M===0){t.progress=100,t.status="done",x(!1),r.isOffline=!0,await new Promise(a=>{m.writeText({uri:`internal://files/${f}`,text:JSON.stringify(r),success:()=>a(!0),fail:()=>a(!1)})}),g.showToast({message:`${e.name} 已完整`});return}console.log(`[App] Need to download ${M}/${n} chapters`),x(!0);const U=A&&typeof A.download=="function";let F=0,O=0,C=0;if(U){t.phase="download",console.log("[App] Using request.download batch mode");let a=0;for(;a<n&&t.status==="running";){if(O>3){console.log("[App] Too many batch fails, fallback to fetch"),g.showToast({message:"切换到备用下载方式"});break}const o=Math.min(a+D-1,n-1),u=[];for(let p=a;p<=o;p++)$.has(`${p}.txt`)||u.push(p);if(u.length===0){C=o+1,t.progress=Math.floor(C/n*100),a=o+1;continue}const N=u[0],T=u[u.length-1],c=await Q(s,N,T);if(c){const p=await W(c,d,u,$);await Z(c),p.saved>0?O=0:O++,F+=p.failed,await new Promise(k=>setTimeout(k,100))}else O++,F+=u.length;C=o+1,t.progress=Math.floor(C/n*100),a=o+1}if(O<=3&&t.status==="running"){t.status="done",x(!1),F===0?(r.isOffline=!0,await new Promise(o=>{m.writeText({uri:`internal://files/${f}`,text:JSON.stringify(r),success:()=>{console.log("[App] Final meta saved: isOffline=true"),o(!0)},fail:()=>o(!1)})}),g.showToast({message:`${e.name} 下载完成`})):g.showToast({message:`${e.name} 缺${F}章，点下载可补全`});return}}t.phase="batch",console.log("[App] Using fetch batch mode");let S=0,q=0,y=0;for(;y<n&&t.status==="running";){if(S>50){g.showToast({message:"失败过多，请稍后重试"}),t.status="error",x(!1);break}const a=Math.min(y+D-1,n-1),o=[];for(let c=y;c<=a;c++)$.has(`${c}.txt`)||o.push(c);if(o.length===0){y=a+1,t.progress=Math.floor(y/n*100);continue}const u=o[0],N=o[o.length-1],T=await X(s,u,N);if(T&&typeof T=="object")for(const c of o){const p=String(c);T[p]?await B(d,c,T[p])&&($.add(`${c}.txt`),S=0):(q++,S++),t.progress=Math.floor((c+1)/n*100)}else for(const c of o){if(t.status!=="running")break;const p=await Y(s,c);p?(await B(d,c,p),$.add(`${c}.txt`),S=0):(S++,q++),t.progress=Math.floor((c+1)/n*100)}y=a+1}t.status="done",x(!1);const J=F+q;J===0?(r.isOffline=!0,await new Promise(a=>{m.writeText({uri:`internal://files/${f}`,text:JSON.stringify(r),success:()=>{console.log("[App] Final meta saved: isOffline=true"),a(!0)},fail:()=>a(!1)})}),g.showToast({message:`${e.name} 下载完成`})):g.showToast({message:`${e.name} 缺${J}章，点下载可补全`})}const R={onCreate(){},start(e){if(h[e.id]&&h[e.id].status==="running"){g.showToast({message:"正在后台下载中..."});return}h[e.id]={id:e.id,progress:0,status:"running",phase:"download",name:e.name},g.showToast({message:`开始下载: ${e.name}`}),v(e)},getTask(e){return h[e]},getRunningTask(){for(const e in h)if(h[e].status==="running")return h[e];return null},clearTask(e){h[e]&&(h[e].status="cancelled",delete h[e],console.log(`[App] Cleared task for book ${e}`))}};$app_define$("@app-component/app",[],function(e,s,n){n.exports=R.default||R,n.exports.style=K});$app_bootstrap$("@app-application/app");
