let h={"@info":{styleObjectId:1182111904}};const l=h,n=$app_require$("@app-module/system.router"),p=$app_require$("@app-module/system.fetch"),r=$app_require$("@app-module/system.file"),d=$app_require$("@app-module/system.storage"),o=$app_require$("@app-module/system.prompt"),i={data:function(){return{bookId:"",bookName:"",chapterIndex:0,chapterCount:0,title:"",chapterTitle:"",paragraphs:[],fullParagraphs:[],loadedCount:0,hasMore:!1,currentTime:"12:00",currentChapter:0,totalChapters:0,isLoading:!1,readPercentage:0,readerStyle:{fontSize:32,lineHeight:48,bgColor:"#000000",textColor:"#ffffff",dimColor:"#888888",cardBgColor:"#333333"}}},onInit(){console.log("阅读器 初始化",this.bookId,this.chapterIndex),console.log("Initial isLoading:",this.isLoading),this.title=this.bookName||"书名",this.currentChapter=Number(this.chapterIndex)||0,this.totalChapters=Number(this.chapterCount)||0,this.updateTime(),this.loadReaderSettings(),this.content?(console.log("Loading from content param"),this.renderChapter(this.content)):this.bookId?this.loadChapter(this.currentChapter):(this.paragraphs=["未找到书籍内容"],this.isLoading=!1),console.log("onInit complete, isLoading:",this.isLoading)},onShow(){console.log("Reader onShow, isLoading:",this.isLoading),this.loadReaderSettings(),this.isLoading&&setTimeout(()=>{this.isLoading&&(this.isLoading=!1,console.log("Force clearing isLoading state"))},2e3)},updateTime(){const t=new Date,s=t.getHours().toString().padStart(2,"0"),e=t.getMinutes().toString().padStart(2,"0");this.currentTime=`${s}:${e}`},loadReaderSettings(){d.get({key:"reader_settings",success:t=>{if(t)try{const s=JSON.parse(t),e=s.theme||"dark";this.readerStyle.fontSize=s.fontSize||32,this.readerStyle.lineHeight=s.lineHeight||48,e==="light"?(this.readerStyle.bgColor="#ffffff",this.readerStyle.textColor="#000000",this.readerStyle.dimColor="#666666",this.readerStyle.cardBgColor="#eeeeee"):e==="green"?(this.readerStyle.bgColor="#cceebb",this.readerStyle.textColor="#000000",this.readerStyle.dimColor="#557744",this.readerStyle.cardBgColor="#aacc99"):(this.readerStyle.bgColor="#000000",this.readerStyle.textColor="#ffffff",this.readerStyle.dimColor="#888888",this.readerStyle.cardBgColor="#333333")}catch(s){console.error("Reader settings parse error",s)}}})},loadChapter(t){console.log(`Loading chapter ${t}, setting isLoading=true`),this.isLoading=!0,this.paragraphs=[];const e=`${`internal://files/book_data_${this.bookId}`}/${t}.txt`;r.readText({uri:e,success:a=>{console.log("本地章节加载成功"),this.renderChapter(a.text)},fail:()=>{console.log("本地章节未找到，尝试网络加载"),this.loadFromNetwork(t)}})},loadFromNetwork(t){p.fetch({url:`http://127.0.0.1:23101/api/novel/chapter?id=${this.bookId}&index=${t}`,method:"GET",responseType:"text",success:s=>{console.log("网络章节加载成功"),this.renderChapter(s.data)},fail:(s,e)=>{console.log(`网络加载失败: ${e}`),o.showToast({message:"加载失败"}),this.paragraphs=["内容加载失败，请检查网络或重新下载"],this.isLoading=!1}})},renderChapter(t){if(!t)this.paragraphs=["章节内容为空"],this.fullParagraphs=[],this.hasMore=!1;else{this.fullParagraphs=t.split(`
`).filter(e=>e.trim()!=="").map(e=>"　　"+e.trim());const s=20;this.fullParagraphs.length>s?(this.paragraphs=this.fullParagraphs.slice(0,s),this.loadedCount=s,this.hasMore=!0,console.log(`Chapter has ${this.fullParagraphs.length} paragraphs, loaded first ${s}`)):(this.paragraphs=this.fullParagraphs,this.loadedCount=this.fullParagraphs.length,this.hasMore=!1)}this.saveProgress(),console.log("Rendering complete, setting isLoading=false"),this.isLoading=!1,setTimeout(()=>{this.scrollToTop()},100)},scrollToTop(){const t=this.$element("contentList");t?(t.scrollTo({index:0}),console.log("Scrolled to top")):console.log("List element not found")},loadMore(){if(!this.hasMore)return;const t=20,s=this.fullParagraphs.length-this.loadedCount,e=Math.min(t,s),a=this.fullParagraphs.slice(this.loadedCount,this.loadedCount+e);this.paragraphs=this.paragraphs.concat(a),this.loadedCount+=e,this.loadedCount>=this.fullParagraphs.length&&(this.hasMore=!1),console.log(`Loaded ${e} more paragraphs, total: ${this.loadedCount}/${this.fullParagraphs.length}`)},prevChapter(){console.log("Prev chapter clicked"),this.currentChapter>0?(this.currentChapter--,this.loadChapter(this.currentChapter)):o.showToast({message:"已经是第一章了"})},nextChapter(){if(console.log("Next chapter clicked"),this.totalChapters>0&&this.currentChapter>=this.totalChapters-1){o.showToast({message:"已经是最后一章了"});return}this.currentChapter++,this.loadChapter(this.currentChapter)},saveProgress(){const t={id:this.bookId,name:this.bookName,chapterCount:this.totalChapters,currentChapter:this.currentChapter},e=`internal://files/${`book_${this.bookId}.json`}`;r.writeText({uri:e,text:JSON.stringify(t)})},handleTap(){},openJump(){},openCatalog(){n.push({uri:"/pages/Catalog",params:{bookId:this.bookId,bookName:this.bookName,currentIndex:this.currentChapter}})},onItemAppear(t){if(this.fullParagraphs&&this.fullParagraphs.length>0){let s=Number(t);if(isNaN(s))return 0;let e=Math.ceil((s+1)/this.fullParagraphs.length*100);e>100&&(e=100),e<1&&(e=1),this.readPercentage=e}}};$app_define$("@app-component/index",[],function(t,s,e){e.exports=i.default||i,e.exports.style=l});$app_bootstrap$("@app-component/index");
