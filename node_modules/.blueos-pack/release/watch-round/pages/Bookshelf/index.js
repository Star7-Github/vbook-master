let d={"@info":{styleObjectId:331959032}};const g=d,c=$app_require$("@app-module/system.router"),n=$app_require$("@app-module/system.file"),h=$app_require$("@app-module/system.prompt"),u={data:function(){return{bookList:[],downloadTask:null,showDeleteAlert:!1,deleteAlertContent:"",deletingBook:null,deleteAlertButtons:[{eventType:"confirm",type:"primary",value:"确定"},{eventType:"cancel",type:"plain",value:"忽略"}],refreshTimer:null,isDeleting:!1}},onInit(){console.log("书架页 初始化"),console.log("onInit - isDeleting:",this.isDeleting),this.pollTimer=null},onShow(){this.isDeleting=!1,console.log("Bookshelf onShow, reset isDeleting to false"),this.refreshBooks(),this.startPolling()},onHide(){this.pollTimer&&clearInterval(this.pollTimer)},onDestroy(){this.pollTimer&&clearInterval(this.pollTimer),this.refreshTimer&&clearTimeout(this.refreshTimer)},startPolling(){!this.$app||!this.$app.$def||!this.$app.$def.getRunningTask||(this.pollTimer&&clearInterval(this.pollTimer),this.checkTask(),this.pollTimer=setInterval(()=>{this.checkTask()},1e3))},checkTask(){const e=this.$app.$def.getRunningTask();e?this.downloadTask={name:e.name,progress:e.progress||0}:this.downloadTask=null},handleTaskClick(){c.push({uri:"pages/Transfer"})},handleLongPress(e){if(console.log("Long press triggered",e.name),e.isLocal){h.showToast({message:"内置书籍无法删除"});return}this.deletingBook=e,this.deleteAlertContent=`确认删除《${e.name}》？`,this.showDeleteAlert=!0,console.log("showDeleteAlert set to true, deletingBook:",e.name)},onDeleteConfirm(){console.log("Delete confirmed"),this.showDeleteAlert=!1,this.deletingBook&&(this.deleteBook(this.deletingBook),this.deletingBook=null)},onDeleteCancel(){console.log("Delete cancelled"),this.showDeleteAlert=!1,this.deletingBook=null},deleteBook(e){if(this.isDeleting=!0,console.log("Starting delete, isDeleting=true"),this.$app&&this.$app.$def&&this.$app.$def.clearTask&&this.$app.$def.clearTask(e.id),e._uri&&n.delete({uri:e._uri,success:()=>console.log("Deleted meta"),fail:(t,s)=>console.log("Delete meta failed",s)}),e.id){const t=`internal://files/book_data_${e.id}`;n.rmdir({uri:t,recursive:!0,success:()=>console.log("Deleted content folder"),fail:(s,a)=>console.log("Delete folder failed",a)})}h.showToast({message:"已删除"}),this.refreshTimer&&clearTimeout(this.refreshTimer),this.refreshTimer=setTimeout(()=>{this.refreshBooks(),this.isDeleting=!1,this.refreshTimer=null,console.log("Delete complete, isDeleting=false")},500)},refreshBooks(){n.list({uri:"internal://files/",success:t=>{console.log("文件列表:",JSON.stringify(t));const a=(t.fileList||[]).filter(l=>l.uri.endsWith(".json")&&l.uri.indexOf("book_")>=0);Promise.all(a.map(l=>new Promise(i=>{n.readText({uri:l.uri,success:o=>{try{const r=JSON.parse(o.text);r._uri=l.uri,i(r)}catch{i(null)}},fail:()=>i(null)})}))).then(l=>{const i=l.filter(o=>o!==null).map(o=>{const r=Number(o.currentChapter)||0,f=Number(o.chapterCount)||1;let p=Math.floor((r+1)*100/f);return p>100&&(p=100),o.progress=p,o});this.bookList=i})},fail:(t,s)=>{console.log(`获取文件列表失败: ${s}, ${t}`)}})},goBack(){c.back()},openBookDetail(e){c.push({uri:"pages/BookDetail",params:{bookId:e.id||"",bookName:e.name,chapterCount:e.chapterCount||0,currentChapter:e.currentChapter||0,rawUri:e._uri||"",isLocal:e.isLocal||!1,content:e.content||""}})}};$app_define$("@app-component/index",[],function(e,t,s){s.exports=u.default||u,s.exports.style=g});$app_bootstrap$("@app-component/index");
