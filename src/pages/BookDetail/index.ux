<template>
  <div class="wrapper">
    <!-- å¤´éƒ¨ä¿¡æ¯åŒº -->
    <div class="info-area">
      <!-- å°é¢å›¾ (ä½¿ç”¨æ–‡å­—é¦–å­—æ¯æ¨¡æ‹Ÿ) -->
      <div class="book-cover">
        <text class="cover-text">{{ bookName.substring(0, 1) }}</text>
      </div>

      <!-- ä¹¦åä¸è¿›åº¦ -->
      <text class="title">{{ bookName }}</text>
      <text class="progress-text" if="{{!isLocal}}">
        å·²è¯» {{ progressPercent }}% ({{ currentChapter }}/{{ chapterCount }}ç« )
      </text>
      <text class="progress-text" if="{{isLocal}}">æœ¬åœ°ä¹¦ç±</text>
    </div>

    <!-- æ“ä½œæŒ‰é’®åŒº -->
    <div class="action-area">
      <!-- é˜…è¯»æŒ‰é’® -->
      <div class="action-btn-wrapper" onclick="startReading">
        <div class="circle-btn read-btn">
          <text class="btn-icon">ğŸ“–</text>
        </div>
        <text class="btn-text">å¼€å§‹é˜…è¯»</text>
      </div>

      <!-- åˆ é™¤æŒ‰é’® -->
      <div class="action-btn-wrapper" onclick="handleDelete">
        <div class="circle-btn delete-btn">
          <text class="btn-icon">ğŸ—‘ï¸</text>
        </div>
        <text class="btn-text">åˆ é™¤ä¹¦ç±</text>
      </div>
    </div>

    <div
      if="{{isDeleting}}"
      style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.5);
      ">
      <text style="color: #ffffff; font-size: 30px">åˆ é™¤ä¸­...</text>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <vw-alert
      if="{{showDeleteAlert}}"
      title="åˆ é™¤ä¹¦ç±"
      content="ç¡®å®šè¦åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚"
      buttons="{{alertButtons}}"
      onclick="onAlertClick"></vw-alert>
  </div>
</template>

<script>
  import router from '@blueos.app.appmanager.router'
  import prompt from '@blueos.window.prompt'
  import file from '@blueos.storage.file'

  export default {
    data: {
      // ä¼ å…¥å‚æ•°
      bookId: '',
      bookName: '',
      chapterCount: 0,
      currentChapter: 0,
      rawUri: '',
      isLocal: false,
      content: '',

      // å†…éƒ¨çŠ¶æ€
      isDeleting: false,
      showDeleteAlert: false,
      alertButtons: [
        {
          eventType: 'confirm',
          type: 'danger',
          value: 'åˆ é™¤',
        },
        {
          eventType: 'cancel',
          type: 'plain',
          value: 'å–æ¶ˆ',
        },
      ],
    },
    onInit() {
      console.log('ä¹¦ç±è¯¦æƒ…é¡µ åˆå§‹åŒ–', this.bookName)
      // å¼ºåˆ¶è½¬æ¢ isLocal ä¸ºå¸ƒå°”å€¼ï¼Œé˜²æ­¢è·¯ç”±ä¼ é€’å­—ç¬¦ä¸² "false" å¯¼è‡´åˆ¤æ–­é”™è¯¯
      if (typeof this.isLocal === 'string') {
        this.isLocal = this.isLocal === 'true'
      }
    },
    computed: {
      progressPercent() {
        // Use Number() to convert
        const current = Number(this.currentChapter) || 0
        const total = Number(this.chapterCount) || 1
        if (total <= 0) return 0

        let p = Math.floor(((current + 1) * 100) / total)
        if (p > 100) p = 100
        return p
      },
    },
    startReading() {
      if (this.isLocal) {
        // å†…ç½®ä¹¦ç±
        router.push({
          uri: 'pages/Reader',
          params: {
            title: this.bookName,
            content: this.content,
            // æ ‡è®°ä¸ºlocalï¼ŒReaderéœ€è¦å¤„ç†contentå‚æ•°
            bookId: 'local_' + this.bookName,
          },
        })
      } else {
        // ä¸‹è½½ä¹¦ç±
        router.push({
          uri: 'pages/Reader',
          params: {
            bookId: this.bookId,
            bookName: this.bookName,
            chapterIndex: this.currentChapter,
            chapterCount: this.chapterCount,
          },
        })
      }
    },
    handleDelete() {
      if (this.isLocal) {
        prompt.showToast({ message: 'å†…ç½®ä¹¦ç±æ— æ³•åˆ é™¤' })
        return
      }

      this.showDeleteAlert = true
    },
    onAlertClick(e) {
      this.showDeleteAlert = false
      if (e.detail && e.detail.eventType === 'confirm') {
        this.confirmDelete()
      }
    },
    stopPropagation(e) {
      if (e.stopPropagation) e.stopPropagation()
    },
    confirmDelete() {
      this.isDeleting = true
      // Execute delete logic
      this.doDeleteFiles()
    },
    doDeleteFiles() {
      // 1. åˆ é™¤å…ƒæ•°æ®æ–‡ä»¶
      if (this.rawUri) {
        file.delete({
          uri: this.rawUri,
          success: () => console.log('Deleted meta'),
          fail: (data, code) => console.log('Delete meta failed', code),
        })
      }

      // 2. åˆ é™¤ä¹¦ç±å†…å®¹ç›®å½•
      if (this.bookId) {
        const dir = `internal://files/book_data_${this.bookId}`
        file.rmdir({
          uri: dir,
          recursive: true,
          success: () => console.log('Deleted content folder'),
          fail: (data, code) => console.log('Delete folder failed', code),
        })
      }

      // 3. æ¸…ç†å¯èƒ½çš„ä¸‹è½½ä»»åŠ¡
      if (this.$app && this.$app.$def && this.$app.$def.clearTask) {
        this.$app.$def.clearTask(this.bookId)
      }

      // å»¶è¿Ÿä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°çŠ¶æ€ï¼Œç„¶åè¿”å›
      setTimeout(() => {
        this.isDeleting = false
        prompt.showToast({ message: 'åˆ é™¤æˆåŠŸ' })
        router.back()
      }, 800)
    },
  }
</script>

<style lang="scss">
  .wrapper {
    flex-direction: column;
    background-color: #000000;
    padding: 40px;
    align-items: center;
  }

  /* é€‚é…åœ†å½¢æ‰‹è¡¨ */
  @media (device: watch-round) {
    .wrapper {
      padding: 60px 40px;
    }
  }

  .info-area {
    flex-direction: column;
    align-items: center;
    margin-bottom: 50px;
    margin-top: 20px;
  }

  .book-cover {
    width: 120px;
    height: 140px;
    background-color: #334455;
    justify-content: center;
    align-items: center;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 2px solid #556677;
  }

  .cover-text {
    font-size: 60px;
    color: #ffffff;
    font-weight: bold;
  }

  .title {
    font-size: 36px;
    color: #ffffff;
    text-align: center;
    margin-bottom: 15px;
    lines: 2;
    text-overflow: ellipsis;
  }

  .progress-text {
    font-size: 26px;
    color: #9393aa;
  }

  .action-area {
    flex-direction: column;
    align-items: center;
    width: 100%;
  }

  .action-btn-wrapper {
    flex-direction: row;
    align-items: center;
    margin-bottom: 30px;
    width: 300px;
    background-color: #1a1a1a;
    padding: 15px 30px;
    border-radius: 40px;
    justify-content: center;
  }

  .action-btn-wrapper:active {
    background-color: #333333;
  }

  .circle-btn {
    width: 50px;
    height: 50px;
    justify-content: center;
    align-items: center;
    margin-right: 20px;
  }

  .btn-icon {
    font-size: 36px;
  }

  .btn-text {
    font-size: 32px;
    color: #ffffff;
  }
</style>
